# CRUDs_fot_poly_kalshi

# ВАЖНО !

возможны баги и разное поведение кода на разных системах (например создание таблиц на виндоввс может происходить в нижнем регистре вместо CamelCase на линуксе, в будующем будет исправлено)

## Описание проекта

Репозиторий содержит реализацию CRUD-операций для работы с асинхронной базой данных PostgreSQL на Python, используя SQLAlchemy и asyncpg. Основное внимание уделено удобному и безопасному управлению соединениями с базой данных через асинхронный пул сессий, а также автоматизированному созданию всех таблиц по моделям.

---

## 1. Создание всех таблиц

Для создания всех таблиц достаточно просто запустить скрипт **create_all_tables.py**:

```bash
python create_all_tables.py
```

Этот скрипт автоматически создаёт все необходимые таблицы в базе данных на основе описанных моделей SQLAlchemy. Перед запуском убедитесь, что переменные окружения для подключения к базе данных корректно настроены в `.env` файле.

---

## 2. Асинхронный пул сессий

Для эффективной работы с базой данных используется асинхронный пул сессий, реализованный через SQLAlchemy с параметрами, задаваемыми из `.env` файла:

- `pool_size` — максимальное количество одновременных соединений.
- `max_overflow` — допустимое превышение пула.
- `pool_timeout`, `pool_recycle`, `pool_pre_ping` — дополнительные параметры для надёжности и производительности.

**Пример инициализации:**
```python
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.orm import sessionmaker

engine = create_async_engine(db_url, ...)
session_factory = sessionmaker(engine, class_=AsyncSession, expire_on_commit=False)
```

### Рекомендуемый способ использования пула сессий

Для безопасной работы с сессиями используйте асинхронный контекстный менеджер:

```python
async with db.session() as session:
    # Ваши запросы к базе данных
```

- Это гарантирует автоматическое закрытие сессии после завершения работы и откат транзакции при ошибках.
- Пул сессий позволяет переиспользовать соединения, снижая нагрузку и повышая производительность.

---

## 3. Структура проекта

- **models/** — описание ORM-моделей таблиц
- **crud/** — функции для операций CRUD
- **main.py** — точка входа, запуск приложения, создание таблиц и инициализация пула сессий
- **create_all_tables.py** — скрипт для создания всех таблиц
- **README.md** — документация

---

## 4. Пример CRUD-операций

В папке `crud/` реализованы функции для создания, чтения, обновления и удаления данных с использованием асинхронных сессий.

**Пример создания записи:**
```python
async with db.session() as session:
    new_user = User(name="...")
    session.add(new_user)
    await session.commit()
```

---

## 5. Запуск проекта

1. Установите зависимости:
    ```bash
    pip install -r requirements.txt
    ```
2. Настройте переменные окружения в `.env` файле (DB_USER, DB_PASSWORD, DB_HOST, DB_PORT, DB_NAME и параметры пула).
3. Импортируйте все модели и вызовите создание таблиц.
4. Для создания всех таблиц просто запустите:
    ```bash
    python create_all_tables.py
    ```
5. Для запуска приложения:
    ```bash
    python main.py
    ```
